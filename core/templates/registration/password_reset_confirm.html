{% extends "core/base.html" %}
{% load i18n %}
{% block title %}{% trans "Set New Password | Dance Portal" %}{% endblock %}

{% block extra_head %}
<style>
  :root { --coral:#d76f54; --ink:#2b2b2b; }

  .auth-wrap{ max-width: 520px; margin: 2.25rem auto 2.75rem; }
  .auth-card{
    border: 1px solid #f0e3df; border-radius: 16px; background:#fff;
    box-shadow: 0 14px 32px rgba(0,0,0,.08); overflow:hidden;
  }
  .auth-head{
    background: linear-gradient(180deg,#fff7f4 0%,#ffece7 100%);
    border-bottom: 1px solid #f1ded9; padding: 1.1rem 1.25rem;
  }
  .auth-head h2{ margin:0; font-weight:800; font-size:1.55rem; color:var(--ink); }

  .form-icon{ width:44px; display:flex; align-items:center; justify-content:center; color:#888; }
  .form-control{ padding:.65rem .9rem; border-radius:10px; }
  .input-group>.form-control{ border-top-left-radius:0; border-bottom-left-radius:0; }
  .toggle-btn{
    border:1px solid #ced4da; border-left:0; background:#fff;
    border-top-right-radius:10px; border-bottom-right-radius:10px; padding:.55rem .8rem;
  }

  .helptext, .password-help{ color:#6b6b6b; font-size:.92rem; }
  .match-hint{ font-size:.92rem; }

  .btn-coral{
    background-color:var(--coral); border-color:var(--coral); color:#fff;
    font-weight:600; border-radius:999px; padding:.65rem 1.25rem;
  }
  .btn-coral:hover{ background:#c45f45; border-color:#c45f45; color:#fff; }
</style>
{% endblock %}

{% block content %}
<div class="auth-wrap">
  <div class="auth-card">
    <div class="auth-head">
      <h2>{% trans "Set a New Password" %}</h2>
    </div>

    <div class="p-4 p-md-4">
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-3">
          {% for error in form.non_field_errors %}
            {{ error }}{% if not forloop.last %}<br>{% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" novalidate>
        {% csrf_token %}

        <!-- New password -->
        <div class="mb-3">
          <label for="id_new_password1" class="form-label fw-semibold">{% trans "New password" %}</label>
          <div class="input-group">
            <span class="input-group-text form-icon"><i class="bi bi-lock"></i></span>
            <input type="password" name="new_password1" id="id_new_password1"
                   class="form-control" required autocomplete="new-password">
            <button type="button" class="toggle-btn" data-target="id_new_password1" aria-label="{% trans 'Show password' %}">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          {# Django’s built-in help text for validators #}
          {% if form.new_password1.help_text %}
            <div class="password-help mt-2">{{ form.new_password1.help_text|safe }}</div>
          {% endif %}
          {% if form.new_password1.errors %}
            <div class="text-danger small mt-1">{{ form.new_password1.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Confirm password -->
        <div class="mb-2">
          <label for="id_new_password2" class="form-label fw-semibold">{% trans "Confirm new password" %}</label>
          <div class="input-group">
            <span class="input-group-text form-icon"><i class="bi bi-shield-lock"></i></span>
            <input type="password" name="new_password2" id="id_new_password2"
                   class="form-control" required autocomplete="new-password">
            <button type="button" class="toggle-btn" data-target="id_new_password2" aria-label="{% trans 'Show password' %}">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          {% if form.new_password2.errors %}
            <div class="text-danger small mt-1">{{ form.new_password2.errors.0 }}</div>
          {% endif %}
          <div id="matchHint" class="match-hint mt-2 text-muted"></div>
        </div>

        <div class="d-grid mt-3">
          <button type="submit" class="btn btn-coral">
            <i class="bi bi-check2-circle me-1"></i>{% trans "Save New Password" %}
          </button>
        </div>
      </form>

      <div class="text-center mt-3">
        <a href="{% url 'login' %}" class="link-secondary text-decoration-none">
          <i class="bi bi-arrow-left me-1"></i>{% trans "Back to Login" %}
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Show/Hide toggles
  document.querySelectorAll('.toggle-btn').forEach(btn=>{
    btn.addEventListener('click', function(){
      const id = this.getAttribute('data-target');
      const input = document.getElementById(id);
      const isText = input.type === 'text';
      input.type = isText ? 'password' : 'text';
      this.innerHTML = isText ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
      this.setAttribute('aria-label', isText ? '{{ _("Show password") }}' : '{{ _("Hide password") }}');
    });
  });

  // Live match hint
  const p1 = document.getElementById('id_new_password1');
  const p2 = document.getElementById('id_new_password2');
  const hint = document.getElementById('matchHint');
  function updateMatch(){
    if (!p1.value || !p2.value){ hint.textContent = ''; return; }
    if (p1.value === p2.value){
      hint.textContent = '{{ _("Passwords match ✓") }}';
      hint.classList.remove('text-danger'); hint.classList.add('text-success');
    } else {
      hint.textContent = '{{ _("Passwords do not match") }}';
      hint.classList.remove('text-success'); hint.classList.add('text-danger');
    }
  }
  if (p1 && p2){
    p1.addEventListener('input', updateMatch);
    p2.addEventListener('input', updateMatch);
  }
</script>
{% endblock %}
