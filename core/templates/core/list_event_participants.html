{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}{% trans "Participants | Dance Portal" %}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "Home" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'event_list' %}">{% trans "Events" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Participants" %}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}

<!-- Header + admin toolbar -->
<div class="d-flex justify-content-between align-items-center mb-2 participants-toolbar">
  <h2 class="mb-0">{% trans "Participants for " %}{{ event.city }} ({{ event.date }})</h2>

  {% if user.is_superuser %}
  <div class="d-flex flex-wrap gap-2">
    <form method="get" action="">
      <button type="submit" name="view" value="summary"
              class="btn btn-coral-outline btn-sm btn-fixed">
        {% trans "View Registered by Club" %}
      </button>
    </form>
    <form method="get" action="{% url 'list_event_participants_by_category' event.id %}">
      <button type="submit" class="btn btn-coral-outline btn-sm btn-fixed">
        {% trans "View Registered by Categories" %}
      </button>
    </form>
  </div>
  {% endif %}
</div>

<!-- Filter -->
<div class="mb-3">
  <input type="search"
         id="participants-search"
         class="form-control"
         placeholder="{% trans 'Search (any column: dancer, club, style, group...)' %}"
         aria-label="{% trans 'Search participants' %}">
</div>

{% if grouped_participations %}
<div class="table-shell">
  <div class="table-responsive">
    <table class="table table-striped table-hover table-sm align-middle participants-table scale-to-fit">
    <thead class="table-light">
      <tr>
        <th scope="col">{% trans "# Dancers" %}</th>
        <th scope="col">{% trans "Dancer(s)" %}</th>
        <th scope="col" class="club-col">{% trans "Club" %}</th>
        <th scope="col">{% trans "Style" %}</th>
        <th scope="col">{% trans "Difficulty" %}</th>
        <th scope="col" class="group-type-col">{% trans "Group Type" %}</th>
        <th scope="col">{% trans "Age Group" %}</th>
        <th scope="col">{% trans "Choreographer" %}</th>
        <th scope="col">{% trans "Choreography" %}</th>
        <th scope="col" class="text-center">{% trans "Music" %}</th>
        <th scope="col" class="text-end">{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for group in grouped_participations %}
      <tr>
        <td class="text-center" data-label="{% trans '# Dancers' %}">{{ group.dancers|length }}</td>
        <td data-label="{% trans 'Dancer(s)' %}">
          {% if group.dancers %}
            {% for dancer in group.dancers %}
              {{ dancer.first_name }} {{ dancer.last_name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
            {% if group.group_name %}
              <span class="text-muted"> ({{ group.group_name }})</span>
            {% endif %}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="club-col" data-label="{% trans 'Club' %}">
          {% if group.dancers %}
            {{ group.dancers.0.club.club_name }}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="style-col" data-label="{% trans 'Style' %}">{{ group.style.name }}</td>
        <td class="text-center" data-label="{% trans 'Difficulty' %}">{{ group.difficulty }}</td>
        <td class="text-center group-type-col" data-label="{% trans 'Group Type' %}">{{ group.group_type }}</td>
        <td class="text-center" data-label="{% trans 'Age Group' %}">{{ group.age_group|default:"-" }}</td>
        <td data-label="{% trans 'Choreographer' %}">{{ group.choreographer_name }}</td>
        <td data-label="{% trans 'Choreography' %}">{{ group.choreography_name|default:"Untitled" }}</td>

        <td class="text-center" data-label="{% trans 'Music' %}">
          {% if group.music_file %}
            <i class="bi bi-check-circle-fill text-success"></i>
          {% else %}
            <i class="bi bi-x-circle-fill text-danger"></i>
          {% endif %}
        </td>

        <!-- Coral Actions Dropdown -->
        <td class="text-end" data-label="{% trans 'Actions' %}">
          <div class="dropdown">
            <button class="btn btn-coral btn-sm dropdown-toggle"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
              {% trans "Actions" %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm">
              <li>
                <a class="dropdown-item text-primary"
                   href="{% url 'edit_participation' group.participation_id %}">
                   <i class="bi bi-pencil-square me-1"></i> {% trans "Edit" %}
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'delete_participation_group' %}"
                      onsubmit="return confirm('Are you sure you want to delete this group?');">
                  {% csrf_token %}
                  <input type="hidden" name="event_id" value="{{ event.id }}">
                  <input type="hidden" name="style_id" value="{{ group.style.id }}">
                  <input type="hidden" name="group_type" value="{{ group.group_type }}">
                  <input type="hidden" name="age_group" value="{{ group.age_group }}">
                  <input type="hidden" name="difficulty" value="{{ group.difficulty }}">
                  <input type="hidden" name="choreographer_name" value="{{ group.choreographer_name }}">
                  <button type="submit" class="dropdown-item text-danger">
                    <i class="bi bi-trash me-1"></i> {% trans "Delete" %}
                  </button>
                </form>
              </li>
            </ul>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    </table>
  </div>
</div>

{% else %}
<p><em>{% trans "No participants yet." %}</em></p>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
  (function() {
    const input = document.getElementById('participants-search');
    const table = document.querySelector('.participants-table');
    if (!input || !table) return;

    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const searchableTextByRow = new Map();

    function normalize(value) {
      return (value || '').toString().toLowerCase().trim();
    }

    function rowSearchText(row) {
      if (searchableTextByRow.has(row)) {
        return searchableTextByRow.get(row);
      }
      const text = normalize(
        Array.from(row.querySelectorAll('td'))
          .map(function(cell) { return cell.textContent || ''; })
          .join(' ')
      );
      searchableTextByRow.set(row, text);
      return text;
    }

    function applyFilter() {
      const query = normalize(input.value);
      rows.forEach(function(row) {
        const shouldShow = !query || rowSearchText(row).includes(query);
        row.classList.toggle('is-filtered-out', !shouldShow);
      });
    }

    input.addEventListener('input', applyFilter);
    input.addEventListener('search', applyFilter);
    input.addEventListener('change', applyFilter);
  })();
</script>
{% endblock %}



