{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}{% trans "Register Dancers" %} | {{ event.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">{% trans "Register Dancers" %}</h2>
  <small class="text-muted">{{ event.location }} â€” {{ event.city }} ({{ event.date }})</small>
</div>

<!-- ðŸ•’ Registration & Music Deadlines -->
<div class="alert alert-dark mb-4">
  <p class="mb-1">
    <strong>{% trans "Registration period" %}:</strong>
    {% if event.registration_start and event.registration_end %}
      {{ event.registration_start }} â†’ {{ event.registration_end }}
    {% else %}
      {% trans "Not set" %}
    {% endif %}
  </p>
  <p class="mb-0">
    <strong>{% trans "Music upload deadline" %}:</strong>
    {% if event.music_end %}
      {{ event.music_end }}
    {% else %}
      {% trans "Open until event date" %} ({{ event.date }})
    {% endif %}
  </p>
</div>

{% if is_superuser %}
  <form method="get" class="mb-4">
    <div class="mb-3">
      <label for="club_id" class="form-label fw-semibold">{% trans "Select Club" %}</label>
      <select name="club_id" id="club_id" class="form-select" onchange="this.form.submit()">
        <option value="">â€” {% trans "Select a club" %} â€”</option>
        {% for club in clubs %}
          <option value="{{ club.id }}" {% if selected_club and club.id == selected_club.id %}selected{% endif %}>
            {{ club.club_name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>
{% endif %}

{% if form %}
  {% if selected_club %}
    <h4 class="fw-semibold mb-3">{% trans "Registering dancers for" %} {{ selected_club.club_name }}</h4>
  {% endif %}

  {% if form.errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">
      {% for field, errors in form.errors.items %}
        {% if field != 'music_file' %}
          <li><strong>{{ field|title }}:</strong> {{ errors|join:", " }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if not is_superuser and not event.registration_open %}
    <div class="alert alert-warning fw-bold mt-3">
      {% trans "Registration is currently closed for this event." %}
    </div>
  {% else %}
    <form method="post" enctype="multipart/form-data" class="p-4 rounded-3 shadow-sm bg-white">
      {% csrf_token %}
      
      <!-- Each section separated visually -->
      <div class="form-section">
        <label for="id_group_type" class="form-label fw-semibold">{% trans "Group Type: " %}</label>
        {{ form.group_type }}
      </div>

      <div class="form-section">
        <hr>
        <label for="id_dancers" class="form-label fw-semibold">{% trans "Select Dancer(s): " %}</label>
        {{ form.dancers }}
        <div id="dancer-tools" class="mt-2">
          <button type="button" class="btn-mini" id="btn-select-all">{% trans "Select all" %}</button>
          <button type="button" class="btn-mini" id="btn-clear">{% trans "Clear" %}</button>
          <span id="sel-count" class="ms-3 text-muted"></span>
        </div>
      </div>

      <div id="group-name-wrapper" class="form-section" style="display:none;">
        <hr>
        <label for="id_group_name" class="form-label fw-semibold">{% trans "Group Name: " %}</label>
        {{ form.group_name }}
      </div>

      <div class="form-section">
        <hr>
        <label for="id_style" class="form-label fw-semibold">{% trans "Style: " %}</label>
        {{ form.style }}
      </div>

      <div class="form-section">
        <hr>
        <label for="id_difficulty" class="form-label fw-semibold">{% trans "Difficulty:" %}</label>
        {{ form.difficulty }}
      </div>

      <div class="form-section">
        <hr>
        <label for="id_age_group" class="form-label fw-semibold">{% trans "Age Group (auto-calculated): " %}</label>
        <div class="d-flex align-items-center">
          {{ form.age_group }}
          {% if avg_age %}
            <span class="ms-2 text-muted small">({% trans "Average age" %}: {{ avg_age }})</span>
          {% endif %}
        </div>
      </div>

      <div class="form-section">
        <hr>
        <label for="id_choreographer_name" class="form-label fw-semibold">{% trans "Choreographer Name: " %}</label>
        {{ form.choreographer_name }}
      </div>

      <div class="form-section">
        <hr>
        <label for="id_choreography_name" class="form-label fw-semibold">{% trans "Choreography Name: " %}</label>
        {{ form.choreography_name }}
      </div>

      <div class="form-section">
        <hr>
        <label for="id_music_file" class="form-label fw-semibold">{% trans "Upload Music File: " %}</label>
        {% if event.music_open or is_superuser %}
          {{ form.music_file }}
          {% if form.music_file.errors %}
            <div class="text-danger small mt-1">{{ form.music_file.errors.0 }}</div>
          {% endif %}
        {% else %}
          <p class="text-muted">{% trans "Music upload period is closed." %}</p>
        {% endif %}
      </div>

      <div class="text-center">
          <button type="submit" class="btn btn-coral">
            {% trans "Register" %}
          </button>
        </div>
    </form>
  {% endif %}
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
/* âœ… Vertical layout styling */
.form-section {
  margin-bottom: 1.25rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #f1d4cc;
  display: flex;
}
.form-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

/* Bootstrap-style field consistency */
select, input[type="text"], input[type="file"], textarea {
  width: 100%;
  border: 1px solid #ced4da;
  border-radius: .375rem;
  padding: .5rem .75rem;
  background-color: #fff;
  font-size: 1rem;
}
select:focus, input:focus, textarea:focus {
  border-color: #d76f54;
  box-shadow: 0 0 0 0.25rem rgba(215,111,84,0.25);
  outline: 0;
}

/* Select2 appearance */
.select2-container--default .select2-selection--multiple {
  min-height: 44px;
  border-radius: .375rem;
  border: 1px solid #ced4da;
  padding: 4px 8px;
  background: #fff;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 16px;
  padding: 4px 10px;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
  color: #fff;
  background: #dc3545;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  line-height: 14px;
  text-align: center;
  margin-right: 4px;
}


button.btn-coral,
.btn.btn-coral,
input.btn-coral[type="submit"],
input.btn.btn-coral[type="submit"] {
  background-color: #d76f54 !important;
  border: 1px solid #d76f54 !important;
  color: #fff !important;
  font-weight: 600 !important;
  border-radius: 8px !important;
  padding: 0.55rem 1.25rem !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
  transition: all 0.2s ease-in-out !important;

  /* override Bootstrap CSS variables */
  --bs-btn-bg: #d76f54 !important;
  --bs-btn-border-color: #d76f54 !important;
  --bs-btn-color: #fff !important;
}

button.btn-coral:hover,
.btn.btn-coral:hover,
input.btn-coral[type="submit"]:hover {
  background-color: #c45f45 !important;
  border-color: #c45f45 !important;
  color: #fff !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}

button.btn-coral:active,
.btn.btn-coral:active,
input.btn-coral[type="submit"]:active {
  background-color: #b34f3a !important;
  border-color: #b34f3a !important;
  transform: translateY(0);
  box-shadow: none;
}
</style>
{% endblock %}

{% block extra_scripts %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
const dancerLimits = {
  'Solo':[1,1], 'Duo':[2,2], 'Trio':[3,3],
  'Group':[4,9], 'Formation':[10,29], 'Production':[30,200]
};

$(function () {
  const dancerSelect = $('#id_dancers');
  const groupTypeSelect = $('#id_group_type');
  const groupNameWrapper = $('#group-name-wrapper');
  const ageGroupField = $('#id_age_group');
  const avgAgeSpan = $('<span style="margin-left:10px; color:gray;" id="avg-age-display"></span>');
  ageGroupField.after(avgAgeSpan);

  function initSelect2Multi(max) {
    dancerSelect.select2({
      width: '100%',
      placeholder: "Type to searchâ€¦",
      allowClear: true,
      closeOnSelect: false,
      maximumSelectionLength: max
    });
  }

  function initSelect2Single() {
    dancerSelect.select2({
      width: '100%',
      placeholder: "Select a dancer",
      allowClear: true,
      closeOnSelect: true
    });
  }

  function refreshCount() {
    let vals = dancerSelect.val() || [];
    if (!Array.isArray(vals)) vals = [vals];
    const count = vals.filter(v => v && v.trim() !== '').length;
    $('#sel-count').text(count ? `${count} selected` : '');
  }

  function updateGroupTypeSettings(preserveSelection = false) {
    const groupType = groupTypeSelect.val();
    const [min,max] = dancerLimits[groupType] || [0,999];
    let selected = dancerSelect.val() || [];
    if (!Array.isArray(selected)) selected = [selected];
    selected = selected.filter(v => v && v.trim() !== '');
    dancerSelect.select2('destroy');

    if (groupType === 'Solo') {
      dancerSelect.prop('multiple', false);
      initSelect2Single();
      if (selected.length) {
        dancerSelect.val(selected[0]).trigger('change');
      } else {
        dancerSelect.val(null).trigger('change');
      }
    } else {
      dancerSelect.prop('multiple', true);
      initSelect2Multi(max);
      if (preserveSelection && selected.length) {
        dancerSelect.val(selected).trigger('change');
      }
    }

    if (['Group','Formation','Production'].includes(groupType)) {
      groupNameWrapper.show();
    } else {
      groupNameWrapper.hide();
      $('#id_group_name').val('');
    }
    refreshCount();
  }

  function updateAgeGroup() {
    let ids = dancerSelect.val();
    if (!ids) ids = [];
    if (!Array.isArray(ids)) ids = [ids];
    ids = ids.filter(x => x && x.trim() !== '');

    if (ids.length === 0) {
      ageGroupField.prop("value","").trigger("change");
      avgAgeSpan.text('');
      refreshCount();
      return;
    }

    $.ajax({
      url: "{% url 'calculate_age_group' event.id %}",
      type: "POST",
      data: { "dancers[]": ids, csrfmiddlewaretoken: '{{ csrf_token }}' },
      success: function (data) {
        if (data.age_group) {
          ageGroupField.prop("value", data.age_group).trigger("change");
          avgAgeSpan.text(`(Average age: ${data.avg_age})`);
        } else {
          ageGroupField.prop("value","").trigger("change");
          avgAgeSpan.text('');
        }
        refreshCount();
      }
    });
  }

  function validateGroupSize() {
    const groupType = groupTypeSelect.val();
    let selected = dancerSelect.val() || [];
    if (!Array.isArray(selected)) selected = [selected];
    const numSelected = selected.filter(x => x && x.trim() !== '').length;
    const [min,max] = dancerLimits[groupType] || [0,999];
    if (numSelected < min || numSelected > max) {
      alert(`${groupType} requires between ${min} and ${max} dancers. You selected ${numSelected}.`);
      return false;
    }
    return true;
  }

  $('#btn-select-all').on('click', function () {
    dancerSelect.find('option').prop('selected', true);
    dancerSelect.trigger('change');
    updateAgeGroup();
  });
  $('#btn-clear').on('click', function () {
    dancerSelect.val(null).trigger('change');
    updateAgeGroup();
  });

  groupTypeSelect.on('change', function () { updateGroupTypeSettings(false); });
  dancerSelect.on('change', updateAgeGroup);
  $("form").on("submit", function (e) { if (!validateGroupSize()) e.preventDefault(); });

  dancerSelect.select2({ width:'100%', placeholder:"Type to searchâ€¦", allowClear:true });
  updateGroupTypeSettings(true);
  updateAgeGroup();
});
</script>
{% endblock %}



