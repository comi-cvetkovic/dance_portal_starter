{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}{% trans "Awards" %} â€“ {{ event.name }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "Home" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'event_list' %}">{% trans "Event List" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Awards" %}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}

<!-- Header + toolbar -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">
    {% trans "Awards" %} â€” {{ event.name }} ({{ event.date }})
  </h2>

  {% if user.is_superuser %}
    <form method="post" action="{% url 'publish_awards' event.id %}" class="d-inline">
      {% csrf_token %}
      {% if event.results_published %}
        <button type="submit" class="btn btn-coral-outline">
          {% trans "Unpublish Awards" %}
        </button>
      {% else %}
        <button type="submit" class="btn btn-coral-outline">
          {% trans "Publish Awards" %}
        </button>
      {% endif %}
    </form>
  {% endif %}
</div>

{% if grouped_results %}
  {% for group_key, results in grouped_results.items %}
    <div class="mb-4">
      <!-- Category bar: readable chips + inline action -->
      <div class="category-bar d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="category-chip">{{ group_key.0 }}</span>
          <span class="category-chip">{{ group_key.1 }}</span>
          <span class="category-chip">{{ group_key.2 }}</span>
          <span class="category-chip">{{ group_key.3 }}</span>
        </div>

        {% if user.is_superuser %}
          <form method="post" action="{% url 'generate_diploma' event.id %}" class="ms-auto">
            {% csrf_token %}
            <input type="hidden" name="category" value="{{ group_key.0 }}|{{ group_key.1 }}|{{ group_key.2 }}|{{ group_key.3 }}">
            <button type="submit" class="btn btn-coral btn-sm">
              ðŸ–¨ {% trans "Preview & Print" %}
            </button>
          </form>
        {% endif %}
      </div>

      {% if results %}
        <!-- Results table -->
        <div class="table-shell">
          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle awards-table">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="col-pos">{% trans "Position" %}</th>
                  <th scope="col" class="col-names">{% trans "Dancer(s) / Group" %}</th>
                  <th scope="col" class="col-choreo">{% trans "Choreography" %}</th>
                  <th scope="col" class="col-club">{% trans "Club" %}</th>
                  <th scope="col" class="text-end col-score">{% trans "Final Score" %}</th>
                  <th scope="col" class="text-end col-actions"></th>
                </tr>
              </thead>
              <tbody>
                {% for item in results %}
                  <tr class="
                      {% if forloop.counter == 1 %} place-first
                      {% elif forloop.counter == 2 %} place-second
                      {% elif forloop.counter == 3 %} place-third
                      {% endif %}
                  ">
                    <td class="text-center fw-bold">
                      {% if forloop.counter == 1 %}ðŸ¥‡{% elif forloop.counter == 2 %}ðŸ¥ˆ{% elif forloop.counter == 3 %}ðŸ¥‰{% endif %}
                      {{ forloop.counter }}
                    </td>
                    <td>
                      {% if item.participation.group_name %}
                        <span class="fw-semibold">{{ item.participation.group_name }}</span>
                      {% else %}
                        {% for d in item.dancers %}
                          {{ d.first_name }} {{ d.last_name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      {% endif %}
                    </td>
                    <td class="fw-semibold">{{ item.participation.choreography_name }}</td>
                    <td>
                      {% if item.dancers %}
                        {{ item.dancers.0.club.club_name }}
                      {% else %}
                        â€“
                      {% endif %}
                    </td>
                    <td class="text-end fw-bold">{{ item.score }}</td>
                    <td class="text-end">
                      <a href="{% url 'participation_scores' item.participation.id %}?group={{ forloop.parentloop.counter0 }}"
                         class="btn btn-coral-outline btn-sm">
                        {% trans "View Detailed Scores" %}
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="alert alert-light border mb-0">
          <em>{% trans "No results for this category yet." %}</em>
        </div>
      {% endif %}
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-warning mb-0">
    {% trans "No results available." %}
  </div>
{% endif %}

{% endblock %}

{% block extra_head %}
<style>
  /* Shells */
  .table-shell{
    background:#fff;
    border:1px solid #eee;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    overflow:hidden;
  }

  /* Category bar: more readable than tiny chips */
  .category-bar{
    background:#fff;
    border:1px solid #eee;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
    padding:.6rem .85rem;
  }
  .category-chip{
    display:inline-block;
    padding:.35rem .6rem;
    border-radius:999px;
    font-weight:600;
    background:#fff7f4;            /* light coral tint */
    border:1px solid #f0e2de;
    color:#6b4b43;
    line-height:1;
    font-size:.9rem;
  }

  /* Table spacing + sticky header */
  .awards-table th,
  .awards-table td{ padding:.65rem 1rem !important; }
  .awards-table th:first-child,
  .awards-table td:first-child{ padding-left:1.25rem !important; }
  .awards-table th:last-child,
  .awards-table td:last-child{ padding-right:1.25rem !important; }

  .awards-table thead th{
    position:sticky; top:0; z-index:2;
    background:#f8f9fa;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }

  /* Column widths */
  .awards-table .col-pos{ width: 110px; }
  .awards-table .col-names{ min-width: 240px; }
  .awards-table .col-choreo{ min-width: 220px; }
  .awards-table .col-club{ min-width: 200px; }
  .awards-table .col-score{ width: 120px; }
  .awards-table .col-actions{ width: 210px; }

  /* Wrapping behavior: no mid-word breaks */
  .awards-table td{
    white-space: normal;
    word-break: normal;
    overflow-wrap: break-word;
  }

  /* Zebra + hover */
  .awards-table tbody tr:nth-child(odd){ background:#fafafa; }
  .awards-table tbody tr:nth-child(even){ background:#fff; }
  .awards-table tbody tr:hover{ background-color: rgba(0,0,0,.03); }

  /* Placement highlight (soft, readable) */
  .place-first  { background: #fff8dc; }  /* gold tint */
  .place-second { background: #f5f5f5; }  /* silver tint */
  .place-third  { background: #ffe9d6; }  /* bronze tint */
</style>
{% endblock %}
