{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}Manage Start List | {{ event.name }}{% endblock %}

{% block content %}
<h2>{% trans "Manage Start List for" %} {{ event.name }} â€“ {{ event.city }} ({{ event.date }})</h2>

<!-- Toolbar ABOVE the table -->
<div id="sticky-toolbar">
    <form id="publish-form" method="post" action="{% url 'publish_start_list' event.id %}" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="mode" id="publish-mode">
        <input type="hidden" name="ordered_ids_json" id="ordered-ids-json">
        <input type="hidden" name="source" value="manage">

        <button type="button" class="btn-default" onclick="submitPublish('current', 'manage')">{% trans "Publish Start List" %}</button>
        <button type="button" class="btn-default" onclick="submitPublish('default')">{% trans "Reset to Default Order" %}</button>
    </form>

    {% if event.start_list_published %}
        <form method="post" action="{% url 'unpublish_start_list' event.id %}" style="display: inline;"
            onsubmit="return confirm('Unpublish the start list?');">
            {% csrf_token %}
            <button type="submit" class="btn-delete">{% trans "Unpublish Start List" %}</button>
        </form>
    {% endif %}
</div>

<div class="table-wrapper">
<table class="start-group" id="group-container" style="width: 100%; border-collapse: collapse; margin-bottom: 2em;">
    <thead>
        <tr>
            <th></th>
            <th>#</th>
            <th>{% trans "Dancer(s)" %}</th>
            <th>{% trans "Choreographer" %}</th>
            <th>{% trans "Choreography" %}</th>
            <th>{% trans "Club" %}</th>
        </tr>
    </thead>

    {% with 0 as global_counter %}
    {% for group_key, group_entries in grouped_entries.items %}
    <tbody class="group-wrapper" data-group="{{ group_key|join:'|' }}">
        <tr class="group-header {% if group_key|join:'|' == highlight_key %}highlighted-group{% endif %}" style="cursor: grab;">
            <td colspan="8" style="font-weight: bold;">
                {{ group_key.0 }} â€“ {{ group_key.1 }} â€“ {{ group_key.2 }} â€“ {{ group_key.3 }}
            </td>
        </tr>

        {% for entry in group_entries %}
        {% with forloop.parentloop.counter0|add:forloop.counter as row_number %}
        <tr data-id="{{ entry.id }}" class="draggable-row">
            <td class="drag-handle">â˜°</td>
            <td>
                {{ entry.global_row_number }}
                {% if entry.start_time %}
                <br><span class="start-time">{{ entry.start_time }}</span>
                {% endif %}
            </td>
            <td>
                {% if entry.group_name|length > 0 and entry.num_dancers|add:0 >= 4 %}
                {{ entry.group_name }}
                {% else %}
                {% for dancer in entry.dancers %}
                {{ dancer.first_name }} {{ dancer.last_name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
                {% endif %}
            </td>
            <td>{{ entry.choreographer }}</td>
            <td>{{ entry.choreography_name }}</td>
            <td>{{ entry.club_name }}</td>
        </tr>
        {% endwith %}
        {% endfor %}

        {% with global_counter|add:group_entries|length as global_counter %}{% endwith %}
    </tbody>
    {% endfor %}
    {% endwith %}
</table>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    #sticky-toolbar {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 1rem;
    }
    .table-wrapper { overflow-x: auto; }
    .start-group th, .start-group td {
        white-space: normal;
        word-break: break-word;
        padding: .6rem .75rem;
    }
    .start-group .start-time {
        font-size: 0.85em; color: gray;
    }

    /* âœ… Highlight style */
    .highlighted-group {
        background-color: #fff7d6 !important;
        border-left: 6px solid #ff9800;
    }

    @media (max-width: 1024px) {
        .start-group th,
        .start-group td {
            font-size: 0.8rem;
            white-space: normal;
            word-break: break-word;
            padding: 3px 4px;
            text-align: left;
        }
        .start-group {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        #sticky-toolbar {
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        #sticky-toolbar button {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const groupContainer = document.getElementById("group-container");

        new Sortable(groupContainer, {
            animation: 200,
            handle: '.group-header',
            ghostClass: 'dragging-group',
            scroll: true,
            scrollSensitivity: 100,
            scrollSpeed: 30,
            forceAutoScrollFallback: true,
            scrollTarget: window
        });

        document.querySelectorAll("tbody.group-wrapper").forEach(tbody => {
            new Sortable(tbody, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'dragging',
                scroll: true,
                scrollSensitivity: 100,
                scrollSpeed: 30,
                forceAutoScrollFallback: true,
                scrollTarget: window,
                draggable: "tr.draggable-row"
            });
        });

        window.submitPublish = function (mode, source = null) {
            const ids = [];
            document.querySelectorAll("tbody.group-wrapper").forEach(wrapper => {
                wrapper.querySelectorAll("tr.draggable-row").forEach(row => {
                    ids.push(row.dataset.id);
                });
            });

            document.getElementById("publish-mode").value = mode;
            document.getElementById("ordered-ids-json").value = JSON.stringify(ids);
            if (source) {
                document.getElementById("publish-form").elements["source"].value = source;
            }
            document.getElementById("publish-form").submit();
        };

        // ðŸ”„ Auto refresh every 10s
        setInterval(() => location.reload(), 10000);

        // ðŸŽ¯ Scroll to highlighted category
        const highlighted = document.querySelector('.highlighted-group');
        if (highlighted) {
            highlighted.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    });
</script>
{% endblock %}
