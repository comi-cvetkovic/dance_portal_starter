{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}Start List | {{ event.name }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "Home" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'event_list' %}">{% trans "Events" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Start List" %}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="text-white">
    {% trans "Start List for" %} {{ event.name }} – {{ event.city }} ({{ event.date }})
  </h2>
</div>

{% if show_entries %}
<div class="table-responsive shadow-sm rounded bg-white p-2">
  <table class="table table-bordered align-middle mb-0 start-list-table scale-to-fit">
    <thead class="table-light">
      <tr>
        <th scope="col">#</th>
        <th scope="col">{% trans "Dancer(s) / Ceremony" %}</th>
        <th scope="col">{% trans "Choreographer" %}</th>
        <th scope="col">{% trans "Choreography" %}</th>
        <th scope="col">{% trans "Club" %}</th>
        {% if is_admin %}
          <th scope="col" class="text-center">{% trans "Dancers" %}</th>
        {% endif %}
      </tr>
    </thead>

    {% for group_key, group_entries in grouped_entries.items %}
    <tbody class="group-wrapper" data-group="{{ group_key|join:'|' }}">
      {% if group_key.0 == "Ceremony" %}
      <tr class="table-info fw-bold text-center">
        <td colspan="{% if is_admin %}6{% else %}5{% endif %}">
          &nbsp;
        </td>
      </tr>
      {% else %}
      <tr class="table-secondary fw-semibold {% if group_key|join:'|' == highlight_key %}highlighted-group{% endif %}">
        <td colspan="{% if is_admin %}6{% else %}5{% endif %}">
          {{ group_key.0 }} – {{ group_key.1 }} – {{ group_key.2 }} – {{ group_key.3 }}
        </td>
      </tr>
      {% endif %}

      {% for entry in group_entries %}
      <tr class="{% if entry.is_ceremony %}ceremony-row{% endif %}">
        {% if entry.is_ceremony %}
          <td colspan="{% if is_admin %}6{% else %}5{% endif %}"><strong>{{ entry.title }}</strong><br>{{ entry.start_time }}</td>
        {% else %}
          <td>
            {{ entry.global_row_number }}
            {% if entry.start_time %}
              <br><span class="text-muted small">{{ entry.start_time }}</span>
            {% endif %}
          </td>
          <td>
            {% if entry.group_name and entry.num_dancers|add:0 >= 4 %}
              <span data-bs-toggle="tooltip" data-bs-custom-class="dp-tooltip" title="{{ entry.dancer_names_text }}">{{ entry.group_name }}</span>
            {% else %}
              {% for dancer in entry.dancers %}
                {{ dancer.first_name }} {{ dancer.last_name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% endif %}
          </td>
          <td>{{ entry.choreographer }}</td>
          <td>{{ entry.choreography_name }}</td>
          <td>{{ entry.club_name }}</td>
          {% if is_admin %}
            <td class="text-center">{{ entry.num_dancers }}</td>
          {% endif %}
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
    {% endfor %}
  </table>
</div>
{% else %}
<div class="alert alert-warning mt-3">
  {% trans "The start list has not been published yet." %}
</div>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
  .highlighted-group {
    background-color: #fff7d6 !important;
    border-left: 6px solid #ff9800;
  }

  .ceremony-row {
    background-color: #e3f2fd !important;
    font-size: 1.05em;
    text-align: center;
    border-top: 3px solid #2196f3;
    border-bottom: 3px solid #2196f3;
  }

  @media (max-width: 1024px) {
    .start-list-table th,
    .start-list-table td {
      font-size: 0.8rem;
      padding: 0.35rem 0.5rem;
    }
  }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
  {% if enable_auto_refresh %}
  // Auto-refresh every 10s (admin only)
  setInterval(() => location.reload(), 10000);
  {% endif %}
</script>
{% endblock %}





