{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}{{ event.name }} – {% trans "Detailed Scores" %}{% endblock %}

{% block content %}

<!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{% trans "Detailed Scores" %} — {{ event.name }}</h2>
  <!-- Breadcrumbs handle navigation -->
</div>

<!-- Category chips -->
<div class="dp-card mb-3">
  <div class="card-body d-flex flex-wrap align-items-center gap-2">
    <span class="badge rounded-pill text-bg-secondary">{{ participation.style.name }}</span>
    <span class="badge rounded-pill text-bg-secondary">{{ participation.group_type }}</span>
    <span class="badge rounded-pill text-bg-secondary">{{ participation.age_group }}</span>
    <span class="badge rounded-pill text-bg-secondary">{{ participation.difficulty }}</span>
  </div>
</div>

<!-- Meta card -->
<div class="dp-card mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="fw-semibold mb-1">{% trans "Club" %}</div>
        <div>{{ club.club_name }}</div>
      </div>
      <div class="col-12 col-md-6">
        <div class="fw-semibold mb-1">{% trans "Choreography" %}</div>
        <div>{{ participation.choreography_name|default:"—" }}</div>
      </div>
      <div class="col-12 col-md-6">
        <div class="fw-semibold mb-1">{% trans "Choreographer" %}</div>
        <div>{{ participation.choreographer_name|default:"—" }}</div>
      </div>
      {% if dancers %}
      <div class="col-12 col-md-6">
        <div class="fw-semibold mb-1">{% trans "Dancer(s)" %}</div>
        <div>
          {% if participation.group_name %}
            {{ participation.group_name }}
          {% else %}
            {% for d in dancers %}
              {{ d.first_name }} {{ d.last_name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Scores table -->
<div class="table-shell mb-3">
  <div class="table-responsive">
    <table class="table table-striped table-hover table-sm align-middle scores-table">
      <thead class="table-light">
        <tr>
          <th scope="col">{% trans "Judge" %}</th>
          <th scope="col">{% trans "Technique (T)" %}</th>
          <th scope="col">{% trans "Composition (C)" %}</th>
          <th scope="col">{% trans "Image (I)" %}</th>
          {% if participation.style.name == "Show Dance" %}
            <th scope="col">{% trans "Show Value (S)" %}</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for js in judge_scores %}
        <tr>
          <td class="fw-semibold">{{ js.judge.first_name }} {{ js.judge.last_name }}</td>

          {# Technique #}
          <td class="{% if js.id in discarded_ids.technique %}cell-discarded{% endif %}">
            {{ js.technique|default:"–" }}
          </td>

          {# Composition #}
          <td class="{% if js.id in discarded_ids.composition %}cell-discarded{% endif %}">
            {{ js.composition|default:"–" }}
          </td>

          {# Image #}
          <td class="{% if js.id in discarded_ids.image %}cell-discarded{% endif %}">
            {{ js.image|default:"–" }}
          </td>

          {# Show Value (optional) #}
          {% if participation.style.name == "Show Dance" %}
          <td class="{% if js.id in discarded_ids.show_value %}cell-discarded{% endif %}">
            {{ js.show_value|default:"–" }}
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Final score + legend -->
<div class="d-flex flex-wrap gap-3 align-items-center">
  <div class="dp-card">
    <div class="card-body py-2 px-3">
      <div class="fw-semibold">
        {% trans "Final Score" %}: <span class="text-success">{{ final_score }}</span>
      </div>
    </div>
  </div>

  <div class="text-muted small">
    <span class="legend-box"></span>
    {% trans "Struck-out values were discarded (e.g., min/max trimming)" %}
  </div>
</div>

{% endblock %}

{% block extra_head %}
<style>
  /* Card wrappers */
  .dp-card{
    background:#fff;
    border:1px solid #eee;
    border-radius:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
    overflow:hidden;
  }
  .dp-card .card-body{ padding:1rem 1.1rem; }

  /* Table shell */
  .table-shell{
    background:#fff;
    border:1px solid #eee;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    overflow:hidden;
  }
  .scores-table th,
  .scores-table td{ padding:.65rem 1rem !important; }
  .scores-table thead th{
    position:sticky; top:0; z-index:2;
    background:#f8f9fa;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }

  /* Discarded score look */
  .cell-discarded{
    color:#999 !important;
    text-decoration: line-through;
  }

  /* Legend marker */
  .legend-box{
    display:inline-block;
    width:10px; height:10px;
    margin-right:.4rem;
    border:1px solid #bbb;
    background: repeating-linear-gradient(
      -45deg,
      #ececec 0, #ececec 4px,
      #f9f9f9 4px, #f9f9f9 8px
    );
    vertical-align: middle;
  }
</style>
{% endblock %}
