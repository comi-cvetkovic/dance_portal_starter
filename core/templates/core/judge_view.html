{% extends 'core/base.html' %}
{% load i18n %}
{% load custom_tags %}
{% block title %}{% trans "Judge" %} – {{ event.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">{% trans "Judging" %} — {{ event.name }}</h2>
</div>

{% if all_scored %}
  <div class="dp-card mb-3">
    <div class="card-body d-flex flex-wrap align-items-center gap-3">
      <div class="badge text-bg-success p-2 px-3">
        {% trans "All entries have been scored!" %}
      </div>
      <form method="post" class="ms-auto">
        {% csrf_token %}
        <button type="submit" name="review" class="btn btn-coral-outline">
          {% trans "Review Scores" %}
        </button>
      </form>
    </div>
  </div>

{% elif current_key %}
  <!-- Active category chips (style – group – age – difficulty) -->
  <div class="dp-card mb-3">
    <div class="card-body d-flex flex-wrap align-items-center gap-2">
      <span class="badge rounded-pill text-bg-secondary">{{ current_key.0 }}</span>
      <span class="badge rounded-pill text-bg-secondary">{{ current_key.1 }}</span>
      <span class="badge rounded-pill text-bg-secondary">{{ current_key.2 }}</span>
      <span class="badge rounded-pill text-bg-secondary">{{ current_key.3 }}</span>
      <span class="ms-2 text-muted small">
        {% trans "Showing Category" %} {{ current_index|add:1 }} {% trans "of" %} {{ total_categories }}
      </span>
    </div>
  </div>

  <form method="post" id="judge-form">
    {% csrf_token %}

    {% for p in current_entries %}
      <div class="score-card dp-card mb-3">
        <div class="card-body">
          <!-- Header: choreography & club -->
          <div class="d-flex flex-wrap justify-content-between align-items-start mb-2 gap-2">
            <div>
              <div class="fw-bold mb-1">
                {% trans "Choreography" %}: <span class="text-dark">{{ p.choreography_name }}</span>
              </div>
              <div class="text-muted small">
                {% trans "Choreographer" %}: {{ p.choreographer_name|default:"—" }}
              </div>
            </div>
            <div class="text-end">
              <span class="badge text-bg-light border">
                {% trans "Club" %}: {{ p.dancer_links.first.dancer.club.club_name }}
              </span>
            </div>
          </div>

          <!-- Dancers / Group -->
          <div class="mb-3">
            <div class="text-muted small mb-1">{% trans "Dancer(s)" %}</div>
            {% if p.group_name %}
              <div class="fw-semibold">{{ p.group_name }}</div>
            {% else %}
              {% if p.dancer_links.all %}
                <div>{{ p.dancer_links.all|join:", " }}</div>
              {% else %}
                <em class="text-muted">{% trans "No dancers registered" %}</em>
              {% endif %}
            {% endif %}
          </div>

          <!-- Scores grid -->
          <div class="row g-3 align-items-center">
            <!-- Technique -->
            <div class="col-12 col-md-6">
              <label class="form-label mb-1">{% trans "Technique (T)" %}</label>
              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm stepper"
                        data-target="technique_{{ p.id }}" data-step="-0.25">–</button>
                <input type="range" name="technique_{{ p.id }}" id="technique_{{ p.id }}"
                       class="form-range score-slider"
                       min="1" max="10" step="0.25"
                       value="{{ existing_scores|get_item:p.id|get_item:'technique'|default:5 }}"
                       data-output="technique_output_{{ p.id }}">
                <output id="technique_output_{{ p.id }}" class="score-out">0</output>
                <button type="button" class="btn btn-outline-success btn-sm stepper"
                        data-target="technique_{{ p.id }}" data-step="0.25">+</button>
              </div>
            </div>

            <!-- Composition -->
            <div class="col-12 col-md-6">
              <label class="form-label mb-1">{% trans "Composition (C)" %}</label>
              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm stepper"
                        data-target="composition_{{ p.id }}" data-step="-0.25">–</button>
                <input type="range" name="composition_{{ p.id }}" id="composition_{{ p.id }}"
                       class="form-range score-slider"
                       min="1" max="10" step="0.25"
                       value="{{ existing_scores|get_item:p.id|get_item:'composition'|default:5 }}"
                       data-output="composition_output_{{ p.id }}">
                <output id="composition_output_{{ p.id }}" class="score-out">0</output>
                <button type="button" class="btn btn-outline-success btn-sm stepper"
                        data-target="composition_{{ p.id }}" data-step="0.25">+</button>
              </div>
            </div>

            <!-- Image -->
            <div class="col-12 col-md-6">
              <label class="form-label mb-1">{% trans "Image (I)" %}</label>
              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm stepper"
                        data-target="image_{{ p.id }}" data-step="-0.25">–</button>
                <input type="range" name="image_{{ p.id }}" id="image_{{ p.id }}"
                       class="form-range score-slider"
                       min="1" max="10" step="0.25"
                       value="{{ existing_scores|get_item:p.id|get_item:'image'|default:5 }}"
                       data-output="image_output_{{ p.id }}">
                <output id="image_output_{{ p.id }}" class="score-out">0</output>
                <button type="button" class="btn btn-outline-success btn-sm stepper"
                        data-target="image_{{ p.id }}" data-step="0.25">+</button>
              </div>
            </div>

            <!-- Show Value (when Show Dance) -->
            {% if p.style.name == "Show Dance" %}
            <div class="col-12 col-md-6">
              <label class="form-label mb-1">{% trans "Show Value (S)" %}</label>
              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm stepper"
                        data-target="show_value_{{ p.id }}" data-step="-0.25">–</button>
                <input type="range" name="show_value_{{ p.id }}" id="show_value_{{ p.id }}"
                       class="form-range score-slider"
                       min="1" max="10" step="0.25"
                       value="{{ existing_scores|get_item:p.id|get_item:'show_value'|default:5 }}"
                       data-output="show_value_output_{{ p.id }}">
                <output id="show_value_output_{{ p.id }}" class="score-out">0</output>
                <button type="button" class="btn btn-outline-success btn-sm stepper"
                        data-target="show_value_{{ p.id }}" data-step="0.25">+</button>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

    <!-- Pager / submit -->
    <div class="d-flex flex-wrap gap-2 justify-content-between justify-content-md-end mt-3">
      <div class="me-auto text-muted small d-none d-md-block">
        {% trans "Category" %} {{ current_index|add:1 }} / {{ total_categories }}
      </div>

      {% if has_prev %}
        <button type="submit" name="prev" class="btn btn-coral-outline">← {% trans "Previous" %}</button>
      {% endif %}

      {% if has_next %}
        <button type="submit" name="next" class="btn btn-coral">{% trans "Save & Next" %} →</button>
      {% else %}
        <button type="submit" name="save_last" class="btn btn-coral">{% trans "Save" %}</button>
      {% endif %}
    </div>
  </form>

{% else %}
  <div class="alert alert-warning mb-0">{% trans "No categories available for judging." %}</div>
{% endif %}
{% endblock %}

{% block extra_head %}
<style>
  /* Card shell reuse (dp-card already defined in dashboard) */
  .dp-card{
    background:#fff;
    border:1px solid #eee;
    border-radius:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
  }

  .score-card .card-body{ padding:1rem 1.25rem; }

  /* Range control look */
  .score-slider{
    flex: 1 1 auto;
    min-width: 120px;
  }
  .form-range{
    height: 2rem;
    padding: 0;
  }
  .form-range::-webkit-slider-thumb{
    width: 20px; height: 20px;
    background: #d76f54; border: 0;
    box-shadow: 0 0 0 3px rgba(215,111,84,.2);
  }
  .form-range::-moz-range-thumb{
    width: 20px; height: 20px;
    background: #d76f54; border: 0;
    box-shadow: 0 0 0 3px rgba(215,111,84,.2);
  }
  .form-range::-webkit-slider-runnable-track{
    height: 6px; border-radius: 999px; background: #e9ecef;
  }
  .form-range::-moz-range-track{
    height: 6px; border-radius: 999px; background: #e9ecef;
  }

  /* Score outputs */
  .score-out{
    display:inline-block; min-width:2.8em;
    text-align:center; font-weight:600;
  }

  /* Avoid mid-word breaks in names */
  .score-card{ word-break: normal; overflow-wrap: break-word; }

  @media (max-width: 768px){
    .score-card .card-body{ padding: 1rem; }
  }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Initialize outputs and live update on input
  document.querySelectorAll('.score-slider').forEach(slider => {
    const out = document.getElementById(slider.dataset.output);
    if (out){ out.textContent = Number(slider.value).toFixed(2).replace(/\.00$/, ''); }
    slider.addEventListener('input', () => {
      if (out){ out.textContent = Number(slider.value).toFixed(2).replace(/\.00$/, ''); }
    });
  });

  // Stepper buttons (+/- 0.25)
  document.querySelectorAll('.stepper').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetName = btn.dataset.target;
      const slider = document.getElementById(targetName);
      if (!slider) return;
      const step = parseFloat(btn.dataset.step || '0');
      const min = parseFloat(slider.min || '1');
      const max = parseFloat(slider.max || '10');
      const next = Math.min(max, Math.max(min, parseFloat(slider.value) + step));
      slider.value = next.toFixed(2);
      const out = document.getElementById(slider.dataset.output);
      if (out){ out.textContent = Number(slider.value).toFixed(2).replace(/\.00$/, ''); }
      // Trigger input event to keep any listeners in sync
      slider.dispatchEvent(new Event('input', { bubbles: true }));
    });
  });
});
</script>
{% endblock %}

